---
title: ğŸ‘Œå¦‚ä½•ç ´ååŒäº²å§”æ´¾æ¨¡å‹
date: 2025-04-25 13:33:41
tags:
	- JVM
categories: ç¬”è®°
--- 
# ğŸ‘Œå¦‚ä½•ç ´ååŒäº²å§”æ´¾æ¨¡å‹

# é¢˜ç›®è¯¦ç»†ç­”æ¡ˆ
## è‡ªå®šä¹‰ç±»åŠ è½½å™¨
é€šè¿‡åˆ›å»ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨å¹¶è¦†ç›–loadClassæ–¹æ³•ï¼Œå¯ä»¥å®ç°ä¸åŒäºåŒäº²å§”æ´¾æœºåˆ¶çš„ç±»åŠ è½½ç­–ç•¥ã€‚

```plain
public class CustomClassLoader extends ClassLoader {
    @Override
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        // å¦‚æœæ˜¯ç‰¹å®šçš„ç±»ï¼Œä¸ä½¿ç”¨åŒäº²å§”æ´¾æœºåˆ¶
        if (name.startsWith("com.example")) {
            // è‡ªå®šä¹‰åŠ è½½é€»è¾‘
            byte[] classData = getClassData(name);
            if (classData != null) {
                return defineClass(name, classData, 0, classData.length);
            }
        }
        // å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾æœºåˆ¶
        return super.loadClass(name);
    }

    private byte[] getClassData(String className) {
        // å®ç°ç±»åŠ è½½çš„é€»è¾‘ï¼Œä¾‹å¦‚ä»æ–‡ä»¶ç³»ç»Ÿæˆ–ç½‘ç»œåŠ è½½ç±»å­—èŠ‚ç 
        return null;
    }
}
```

## é€šè¿‡åå°„æœºåˆ¶
åˆ©ç”¨åå°„æœºåˆ¶ç›´æ¥æ“ä½œç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨ï¼Œç»•è¿‡åŒäº²å§”æ´¾æœºåˆ¶ã€‚

```plain
import java.lang.reflect.Field;

public class BreakParentDelegation {
    public static void main(String[] args) throws Exception {
        CustomClassLoader customClassLoader = new CustomClassLoader();
        ClassLoader appClassLoader = ClassLoader.getSystemClassLoader();

        // è·å–ç³»ç»Ÿç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨ï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰
        Field parentField = ClassLoader.class.getDeclaredField("parent");
        parentField.setAccessible(true);
        parentField.set(appClassLoader, customClassLoader);

        // ç°åœ¨ç³»ç»Ÿç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨è¢«æ›¿æ¢ä¸ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨
        Class<?> clazz = Class.forName("com.example.MyClass", true, appClassLoader);
        System.out.println(clazz.getClassLoader());
    }
}
```

## OSGi æ¡†æ¶
OSGi æ¡†æ¶æä¾›äº†ä¸€ç§æ¨¡å—åŒ–çš„ç±»åŠ è½½æœºåˆ¶ï¼Œå…è®¸æ¯ä¸ªæ¨¡å—ï¼ˆBundleï¼‰æœ‰è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä»è€Œå¯ä»¥æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ã€‚

```plain
// OSGi ä¸­çš„ BundleActivator ç¤ºä¾‹
public class MyBundleActivator implements BundleActivator {
    @Override
    public void start(BundleContext context) throws Exception {
        // åœ¨ OSGi ç¯å¢ƒä¸­ï¼Œæ¯ä¸ª Bundle æœ‰è‡ªå·±çš„ç±»åŠ è½½å™¨
        ClassLoader bundleClassLoader = getClass().getClassLoader();
        Class<?> clazz = bundleClassLoader.loadClass("com.example.MyClass");
        System.out.println(clazz.getClassLoader());
    }

    @Override
    public void stop(BundleContext context) throws Exception {
        // åœæ­¢ Bundle æ—¶çš„æ¸…ç†å·¥ä½œ
    }
}
```

## ä½¿ç”¨ SPIï¼ˆService Provider Interfaceï¼‰
æŸäº›æœåŠ¡æä¾›è€…æ¥å£çš„å®ç°ä¸­ï¼Œå¯èƒ½éœ€è¦æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶æ¥åŠ è½½æœåŠ¡å®ç°ç±»ã€‚

```java
import java.util.ServiceLoader;

public class SPIDemo {
    public static void main(String[] args) {
        ServiceLoader<MyService> loader = ServiceLoader.load(MyService.class);
        for (MyService service : loader) {
            service.execute();
        }
    }
}
```

åœ¨META-INF/servicesç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ºæ¥å£çš„å…¨é™å®šåï¼Œæ–‡ä»¶å†…å®¹ä¸ºå®ç°ç±»çš„å…¨é™å®šåã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒJVM ä¼šä½¿ç”¨Thread.contextClassLoaderæ¥åŠ è½½æœåŠ¡å®ç°ç±»ï¼Œä»è€Œå¯ä»¥æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ã€‚